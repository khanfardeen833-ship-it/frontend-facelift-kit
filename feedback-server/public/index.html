<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Feedback - HRMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .star-rating {
            display: flex;
            gap: 4px;
        }
        .star {
            cursor: pointer;
            transition: all 0.2s;
        }
        .star:hover {
            transform: scale(1.1);
        }
        .step-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e5e7eb;
            transition: all 0.3s;
        }
        .step-indicator.active {
            background: #8b5cf6;
        }
        .step-indicator.completed {
            background: #10b981;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="gradient-bg text-white py-6">
        <div class="max-w-4xl mx-auto px-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">Manager Feedback</h1>
                    <p class="text-purple-100 mt-1">Professional Interview Assessment System</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-purple-100">Powered by HRMS</div>
                    <div class="text-xs text-purple-200">Secure & Confidential</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- Error/Success Messages -->
        <div id="messageContainer" class="mb-6"></div>

        <!-- Progress Bar -->
        <div class="bg-white rounded-lg p-6 card-shadow mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Interview Feedback</h2>
                <div class="text-sm text-gray-500">
                    Step <span id="currentStep">1</span> of 4
                </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-blue-500 h-2 rounded-full transition-all duration-500" style="width: 25%"></div>
            </div>
            <div class="flex justify-between mt-4">
                <div class="step-indicator completed" id="step1"></div>
                <div class="step-indicator" id="step2"></div>
                <div class="step-indicator" id="step3"></div>
                <div class="step-indicator" id="step4"></div>
            </div>
        </div>

        <!-- Candidate Info Card -->
        <div class="bg-white rounded-lg p-6 card-shadow mb-6">
            <div class="flex items-center space-x-4">
                <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-blue-500 rounded-full flex items-center justify-center">
                    <i data-lucide="user" class="w-8 h-8 text-white"></i>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-gray-800" id="candidateName">Loading...</h3>
                    <p class="text-gray-600" id="candidateEmail">Loading...</p>
                    <div class="flex items-center space-x-4 mt-2">
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm" id="jobTitle">Loading...</span>
                        <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm" id="roundName">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feedback Form -->
        <div class="bg-white rounded-lg card-shadow">
            <!-- Step 1: Overall Assessment -->
            <div id="step1Content" class="p-6 fade-in">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                        <i data-lucide="star" class="w-6 h-6 text-blue-600"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">Overall Assessment</h3>
                        <p class="text-gray-600">Rate the candidate's overall performance</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <!-- Overall Rating -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Overall Rating *</label>
                        <div class="star-rating" id="overallRating">
                            <i data-lucide="star" class="star w-8 h-8 text-gray-300" data-rating="1"></i>
                            <i data-lucide="star" class="star w-8 h-8 text-gray-300" data-rating="2"></i>
                            <i data-lucide="star" class="star w-8 h-8 text-gray-300" data-rating="3"></i>
                            <i data-lucide="star" class="star w-8 h-8 text-gray-300" data-rating="4"></i>
                            <i data-lucide="star" class="star w-8 h-8 text-gray-300" data-rating="5"></i>
                        </div>
                        <p class="text-sm text-gray-500 mt-2" id="ratingText">Click to rate</p>
                    </div>

                    <!-- Decision -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Hiring Decision *</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="decision" value="strong_hire" class="mr-3">
                                <span class="text-sm font-medium">Strong Hire</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="decision" value="hire" class="mr-3">
                                <span class="text-sm font-medium">Hire</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="decision" value="maybe" class="mr-3">
                                <span class="text-sm font-medium">Maybe</span>
                            </label>
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                <input type="radio" name="decision" value="no_hire" class="mr-3">
                                <span class="text-sm font-medium">No Hire</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Detailed Ratings -->
            <div id="step2Content" class="p-6 hidden">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4">
                        <i data-lucide="bar-chart-3" class="w-6 h-6 text-green-600"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">Detailed Assessment</h3>
                        <p class="text-gray-600">Rate specific skills and competencies</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Technical Skills</label>
                        <div class="star-rating" id="technicalSkills">
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="1"></i>
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="2"></i>
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="3"></i>
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="4"></i>
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="5"></i>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Communication Skills</label>
                        <div class="star-rating" id="communicationSkills">
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="1"></i>
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="2"></i>
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="3"></i>
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="4"></i>
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="5"></i>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Problem Solving</label>
                        <div class="star-rating" id="problemSolving">
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="1"></i>
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="2"></i>
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="3"></i>
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="4"></i>
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="5"></i>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Cultural Fit</label>
                        <div class="star-rating" id="culturalFit">
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="1"></i>
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="2"></i>
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="3"></i>
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="4"></i>
                            <i data-lucide="star" class="star w-6 h-6 text-gray-300" data-rating="5"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Written Feedback -->
            <div id="step3Content" class="p-6 hidden">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mr-4">
                        <i data-lucide="edit-3" class="w-6 h-6 text-yellow-600"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">Written Feedback</h3>
                        <p class="text-gray-600">Provide detailed written assessment</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Key Strengths</label>
                        <textarea id="strengths" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="What are the candidate's main strengths?"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Areas for Improvement</label>
                        <textarea id="areasForImprovement" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="What areas could the candidate improve?"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Detailed Feedback</label>
                        <textarea id="detailedFeedback" rows="6" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Provide comprehensive feedback about the candidate's performance, skills, and potential..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Final Recommendation</label>
                        <textarea id="recommendation" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Your final recommendation and thoughts..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Step 4: Final Review -->
            <div id="step4Content" class="p-6 hidden">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mr-4">
                        <i data-lucide="check-circle" class="w-6 h-6 text-orange-600"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">Final Review</h3>
                        <p class="text-gray-600">Review your feedback before submitting</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <!-- Candidate Information -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-3">Candidate Information</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="font-medium">Name:</span> <span id="reviewCandidateName">-</span></div>
                            <div><span class="font-medium">Email:</span> <span id="reviewCandidateEmail">-</span></div>
                            <div><span class="font-medium">Position:</span> <span id="reviewJobTitle">-</span></div>
                            <div><span class="font-medium">Round:</span> <span id="reviewRoundName">-</span></div>
                        </div>
                    </div>

                    <!-- Overall Assessment -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-3">Overall Assessment</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="font-medium">Overall Rating:</span> <span id="reviewOverallRating">-</span></div>
                            <div><span class="font-medium">Decision:</span> <span id="reviewDecision">-</span></div>
                        </div>
                    </div>

                    <!-- Key Strengths -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-3">Key Strengths</h4>
                        <p class="text-sm text-gray-700" id="reviewStrengths">-</p>
                    </div>

                    <!-- Areas for Improvement -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-800 mb-3">Areas for Improvement</h4>
                        <p class="text-sm text-gray-700" id="reviewAreasForImprovement">-</p>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="flex justify-between items-center p-6 border-t border-gray-200">
                <button id="prevBtn" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors hidden">
                    <i data-lucide="arrow-left" class="w-4 h-4 inline mr-2"></i>
                    Previous
                </button>
                <div class="flex-1"></div>
                <button id="nextBtn" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg hover:from-purple-600 hover:to-blue-600 transition-all">
                    Next
                    <i data-lucide="arrow-right" class="w-4 h-4 inline ml-2"></i>
                </button>
                <button id="submitBtn" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors hidden">
                    <i data-lucide="send" class="w-4 h-4 inline mr-2"></i>
                    Submit Feedback
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Global variables
        let currentStep = 1;
        const totalSteps = 4;
        let formData = {};

        // URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const candidateData = {
            interview_id: urlParams.get('interview_id'),
            candidate_id: urlParams.get('candidate_id'),
            candidate_name: decodeURIComponent(urlParams.get('candidate_name') || ''),
            candidate_email: decodeURIComponent(urlParams.get('candidate_email') || ''),
            job_title: decodeURIComponent(urlParams.get('job_title') || ''),
            round_name: decodeURIComponent(urlParams.get('round_name') || '')
        };

        // Debug: Log the URL parameters
        console.log('URL Parameters:', {
            interview_id: candidateData.interview_id,
            candidate_id: candidateData.candidate_id,
            candidate_name: candidateData.candidate_name,
            candidate_email: candidateData.candidate_email,
            job_title: candidateData.job_title,
            round_name: candidateData.round_name
        });

        // Store the flag for missing data - we'll fetch after DOM is ready
        const needsDataFetch = !candidateData.candidate_name || !candidateData.candidate_email;

        // Function to fetch candidate data from the main HRMS API
        async function fetchCandidateDataFromAPI() {
            try {
                console.log('Attempting to fetch candidate data from API...');
                console.log('Available data:', candidateData);

                // If we have candidate_id, try to fetch candidate details
                if (candidateData.candidate_id) {
                    console.log(`Fetching candidate data for ID: ${candidateData.candidate_id}`);
                    const response = await fetch(`http://localhost:5000/api/interviews/candidate/${candidateData.candidate_id}`, {
                        headers: {
                            'X-API-Key': 'sk-hiring-bot-2024-secret-key-xyz789',
                            'Content-Type': 'application/json'
                        }
                    });

                    console.log('Candidate API response status:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Candidate API response data:', data);
                        
                        if (data.success && data.data) {
                            const candidate = data.data;
                            candidateData.candidate_name = candidate.applicant_name || candidate.candidate_name || 'Unknown Candidate';
                            candidateData.candidate_email = candidate.applicant_email || candidate.candidate_email || 'Unknown Email';
                            candidateData.job_title = candidate.job_title || 'Unknown Position';
                            candidateData.round_name = candidate.round_name || 'Unknown Round';
                            
                            console.log('Successfully fetched candidate data:', candidateData);
                            
                            // Update the UI with the fetched data
                            updateCandidateDisplay();
                            return;
                        }
                    } else {
                        console.error('Candidate API request failed:', response.status, response.statusText);
                    }
                }

                // If we have interview_id, try to fetch interview details
                if (candidateData.interview_id) {
                    console.log(`Fetching interview data for ID: ${candidateData.interview_id}`);
                    const response = await fetch(`http://localhost:5000/api/interviews/${candidateData.interview_id}`, {
                        headers: {
                            'X-API-Key': 'sk-hiring-bot-2024-secret-key-xyz789',
                            'Content-Type': 'application/json'
                        }
                    });

                    console.log('Interview API response status:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Interview API response data:', data);
                        
                        if (data.success && data.data) {
                            const interview = data.data;
                            candidateData.candidate_name = interview.applicant_name || interview.candidate_name || 'Unknown Candidate';
                            candidateData.candidate_email = interview.applicant_email || interview.candidate_email || 'Unknown Email';
                            candidateData.job_title = interview.job_title || 'Unknown Position';
                            candidateData.round_name = interview.round_name || 'Unknown Round';
                            
                            console.log('Successfully fetched interview data:', candidateData);
                            
                            // Update the UI with the fetched data
                            updateCandidateDisplay();
                            return;
                        }
                    } else {
                        console.error('Interview API request failed:', response.status, response.statusText);
                    }
                }

                console.log('Could not fetch candidate data from API, using fallback values');
                
                // If we have some data from URL parameters, use it
                if (candidateData.candidate_id || candidateData.interview_id) {
                    // Use fallback values but keep the IDs
                    candidateData.candidate_name = candidateData.candidate_name || 'Sample Candidate';
                    candidateData.candidate_email = candidateData.candidate_email || 'sample@example.com';
                    candidateData.job_title = candidateData.job_title || 'Sample Position';
                    candidateData.round_name = candidateData.round_name || 'Sample Round';
                }
                
                // Update display with fallback values
                updateCandidateDisplay();
            } catch (error) {
                console.error('Error fetching candidate data from API:', error);
                // Update display with fallback values even on error
                updateCandidateDisplay();
            }
        }

        // Function to update the candidate display in the UI
        function updateCandidateDisplay() {
            document.getElementById('candidateName').textContent = candidateData.candidate_name || 'Unknown Candidate';
            document.getElementById('candidateEmail').textContent = candidateData.candidate_email || 'Unknown Email';
            document.getElementById('jobTitle').textContent = candidateData.job_title || 'Unknown Position';
            document.getElementById('roundName').textContent = candidateData.round_name || 'Unknown Round';
        }

        // Initialize the form
        async function initForm() {
            // Populate candidate information
            updateCandidateDisplay();

            // If we need to fetch data from API, do it now
            if (needsDataFetch) {
                console.log('Missing candidate data from URL parameters, attempting to fetch from API...');
                await fetchCandidateDataFromAPI();
            }

            // Setup star ratings
            setupStarRating('overallRating', 'overall_rating');
            setupStarRating('technicalSkills', 'technical_skills');
            setupStarRating('communicationSkills', 'communication_skills');
            setupStarRating('problemSolving', 'problem_solving');
            setupStarRating('culturalFit', 'cultural_fit');

            // Setup navigation
            document.getElementById('nextBtn').addEventListener('click', nextStep);
            document.getElementById('prevBtn').addEventListener('click', prevStep);
            document.getElementById('submitBtn').addEventListener('click', submitFeedback);

            updateStepDisplay();
        }

        // Setup star rating functionality
        function setupStarRating(containerId, dataKey) {
            const container = document.getElementById(containerId);
            const stars = container.querySelectorAll('.star');
            
            stars.forEach((star, index) => {
                star.addEventListener('click', () => {
                    const rating = index + 1;
                    formData[dataKey] = rating;
                    
                    // Update star display
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.classList.remove('text-gray-300');
                            s.classList.add('text-yellow-400', 'fill-current');
                        } else {
                            s.classList.remove('text-yellow-400', 'fill-current');
                            s.classList.add('text-gray-300');
                        }
                    });

                    // Update rating text for overall rating
                    if (dataKey === 'overall_rating') {
                        const ratingTexts = ['Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
                        document.getElementById('ratingText').textContent = ratingTexts[rating - 1];
                    }
                });
            });
        }

        // Navigation functions
        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep < totalSteps) {
                    currentStep++;
                    updateStepDisplay();
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }

        // Validate current step
        function validateCurrentStep() {
            if (currentStep === 1) {
                if (!formData.overall_rating) {
                    showMessage('Please provide an overall rating', 'error');
                    return false;
                }
                const decision = document.querySelector('input[name="decision"]:checked');
                if (!decision) {
                    showMessage('Please select a hiring decision', 'error');
                    return false;
                }
                formData.decision = decision.value;
            }
            return true;
        }

        // Update step display
        function updateStepDisplay() {
            // Hide all steps
            for (let i = 1; i <= totalSteps; i++) {
                document.getElementById(`step${i}Content`).classList.add('hidden');
                document.getElementById(`step${i}`).classList.remove('active', 'completed');
            }

            // Show current step
            document.getElementById(`step${currentStep}Content`).classList.remove('hidden');
            document.getElementById(`step${currentStep}`).classList.add('active');

            // Mark previous steps as completed
            for (let i = 1; i < currentStep; i++) {
                document.getElementById(`step${i}`).classList.add('completed');
            }

            // Update progress bar
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('currentStep').textContent = currentStep;

            // Update navigation buttons
            document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 1);
            document.getElementById('nextBtn').classList.toggle('hidden', currentStep === totalSteps);
            document.getElementById('submitBtn').classList.toggle('hidden', currentStep !== totalSteps);

            // Update review data if on final step
            if (currentStep === totalSteps) {
                updateReviewData();
            }
        }

        // Update review data
        function updateReviewData() {
            document.getElementById('reviewCandidateName').textContent = candidateData.candidate_name || '-';
            document.getElementById('reviewCandidateEmail').textContent = candidateData.candidate_email || '-';
            document.getElementById('reviewJobTitle').textContent = candidateData.job_title || '-';
            document.getElementById('reviewRoundName').textContent = candidateData.round_name || '-';
            
            const ratingTexts = ['Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
            document.getElementById('reviewOverallRating').textContent = formData.overall_rating ? ratingTexts[formData.overall_rating - 1] : '-';
            document.getElementById('reviewDecision').textContent = formData.decision ? formData.decision.replace('_', ' ').toUpperCase() : '-';
            document.getElementById('reviewStrengths').textContent = document.getElementById('strengths').value || '-';
            document.getElementById('reviewAreasForImprovement').textContent = document.getElementById('areasForImprovement').value || '-';
        }

        // Submit feedback
        async function submitFeedback() {
            // Collect all form data
            const feedbackData = {
                ...candidateData,
                ...formData,
                technical_skills: formData.technical_skills || 0,
                communication_skills: formData.communication_skills || 0,
                problem_solving: formData.problem_solving || 0,
                cultural_fit: formData.cultural_fit || 0,
                strengths: document.getElementById('strengths').value,
                areas_for_improvement: document.getElementById('areasForImprovement').value,
                detailed_feedback: document.getElementById('detailedFeedback').value,
                recommendation: document.getElementById('recommendation').value,
                submitted_by: 'Manager'
            };

            try {
                showMessage('Submitting feedback...', 'info');
                
                const response = await fetch('/api/submit-feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(feedbackData)
                });

                const result = await response.json();

                if (result.success) {
                    // Show success message and redirect to thank you page
                    showThankYouPage();
                } else {
                    showMessage(`❌ Error: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error submitting feedback:', error);
                showMessage('❌ Failed to submit feedback. Please try again.', 'error');
            }
        }

        // Show message
        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const bgColor = type === 'error' ? 'bg-red-100 border-red-400 text-red-700' : 
                           type === 'success' ? 'bg-green-100 border-green-400 text-green-700' :
                           'bg-blue-100 border-blue-400 text-blue-700';
            
            container.innerHTML = `
                <div class="border-l-4 p-4 ${bgColor} rounded">
                    <div class="flex">
                        <div class="ml-3">
                            <p class="text-sm">${message}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Auto-hide info messages
            if (type === 'info') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 3000);
            }
        }

        // Show thank you page after successful submission
        function showThankYouPage() {
            const mainContent = document.querySelector('.max-w-4xl');
            const candidateName = document.getElementById('candidateName').textContent;
            const jobTitle = document.getElementById('jobTitle').textContent;
            
            mainContent.innerHTML = `
                <!-- Success Animation -->
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-r from-green-400 to-green-600 rounded-full mb-6">
                        <i data-lucide="check" class="w-12 h-12 text-white"></i>
                    </div>
                    <h1 class="text-4xl font-bold text-gray-800 mb-4">Thank You!</h1>
                    <p class="text-xl text-gray-600 mb-8">Your feedback has been successfully submitted</p>
                </div>

                <!-- Success Card -->
                <div class="bg-white rounded-lg p-8 card-shadow mb-6">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i data-lucide="user-check" class="w-10 h-10 text-white"></i>
                        </div>
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Feedback Submitted Successfully</h2>
                        <p class="text-gray-600 mb-6">Your comprehensive assessment for <strong>${candidateName}</strong> has been recorded for the <strong>${jobTitle}</strong> position.</p>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                            <div class="flex items-center justify-center mb-4">
                                <i data-lucide="shield-check" class="w-8 h-8 text-green-600 mr-3"></i>
                                <h3 class="text-lg font-semibold text-green-800">Secure & Confidential</h3>
                            </div>
                            <p class="text-green-700 text-sm">Your feedback is securely stored and will be used confidentially for hiring decisions.</p>
                        </div>

                        <div class="space-y-4">
                            <div class="flex items-center justify-center text-gray-600">
                                <i data-lucide="clock" class="w-5 h-5 mr-2"></i>
                                <span>Submitted on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</span>
                            </div>
                            <div class="flex items-center justify-center text-gray-600">
                                <i data-lucide="users" class="w-5 h-5 mr-2"></i>
                                <span>Your assessment will help the HR team make informed decisions</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Next Steps Card -->
                <div class="bg-white rounded-lg p-6 card-shadow mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">What Happens Next?</h3>
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="text-center">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i data-lucide="file-text" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">Review Process</h4>
                            <p class="text-sm text-gray-600">HR team will review your feedback along with other assessments</p>
                        </div>
                        <div class="text-center">
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i data-lucide="users" class="w-6 h-6 text-purple-600"></i>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">Team Discussion</h4>
                            <p class="text-sm text-gray-600">Your insights will be discussed in the hiring committee</p>
                        </div>
                        <div class="text-center">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i data-lucide="mail" class="w-6 h-6 text-green-600"></i>
                            </div>
                            <h4 class="font-semibold text-gray-800 mb-2">Final Decision</h4>
                            <p class="text-sm text-gray-600">Candidate will be notified of the final hiring decision</p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="text-center">
                    <button onclick="window.close()" class="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-8 py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-blue-600 transition-all duration-200 mr-4">
                        <i data-lucide="x" class="w-5 h-5 inline mr-2"></i>
                        Close Window
                    </button>
                    <button onclick="window.print()" class="bg-gray-100 text-gray-700 px-8 py-3 rounded-lg font-semibold hover:bg-gray-200 transition-all duration-200">
                        <i data-lucide="printer" class="w-5 h-5 inline mr-2"></i>
                        Print Confirmation
                    </button>
                </div>

                <!-- Footer -->
                <div class="text-center mt-8 text-gray-500 text-sm">
                    <p>Powered by HRMS Professional Interview Assessment System</p>
                    <p class="mt-1">Thank you for your valuable time and feedback</p>
                </div>
            `;
            
            // Re-initialize Lucide icons for the new content
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Auto-close after 10 seconds
            setTimeout(() => {
                if (confirm('Would you like to close this window?')) {
                    window.close();
                }
            }, 10000);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            await initForm();
        });
    </script>
</body>
</html>
